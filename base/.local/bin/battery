#!/usr/bin/env bash

# Find the first battery device
BAT_PATH=$(upower -e | grep 'BAT' | head -n 1)

if [ -z "$BAT_PATH" ]; then
	exit 0
fi

# Get all info in one go to avoid race conditions/multiple calls
UPOWER_OUTPUT=$(upower -i "$BAT_PATH")

# Extract values using grep and awk
STATUS=$(echo "$UPOWER_OUTPUT" | grep "state:" | awk '{print $2}')
PERCENTAGE=$(echo "$UPOWER_OUTPUT" | grep "percentage:" | awk '{print $2}' | tr -d '%')
TIME_TO_EMPTY=$(echo "$UPOWER_OUTPUT" | grep "time to empty:" | awk '{print $4, $5}')
TIME_TO_FULL=$(echo "$UPOWER_OUTPUT" | grep "time to full:" | awk '{print $4, $5}')

# Format time info
TIME_INFO=""
if [ "$STATUS" = "discharging" ] && [ -n "$TIME_TO_EMPTY" ]; then
	VAL=$(echo "$TIME_TO_EMPTY" | awk '{print $1}')
	UNIT=$(echo "$TIME_TO_EMPTY" | awk '{print $2}')

	if [[ "$UNIT" == "hours" ]]; then
		# Convert decimal hours to HH:MM using awk
		HOURS=$(echo "$VAL" | awk '{print int($1)}')
		MINUTES=$(echo "$VAL" | awk '{print int(($1 - int($1)) * 60)}')
		TIME_INFO=" ($(printf "%02d:%02d" "$HOURS" "$MINUTES"))"
	elif [[ "$UNIT" == "minutes" ]]; then
		TIME_INFO=" (00:$(printf "%02d" "${VAL%.*}"))"
	fi

elif [ "$STATUS" = "charging" ] && [ -n "$TIME_TO_FULL" ]; then
	VAL=$(echo "$TIME_TO_FULL" | awk '{print $1}')
	UNIT=$(echo "$TIME_TO_FULL" | awk '{print $2}')

	if [[ "$UNIT" == "hours" ]]; then
		HOURS=$(echo "$VAL" | awk '{print int($1)}')
		MINUTES=$(echo "$VAL" | awk '{print int(($1 - int($1)) * 60)}')
		TIME_INFO=" ($(printf "%02d:%02d" "$HOURS" "$MINUTES"))"
	elif [[ "$UNIT" == "minutes" ]]; then
		TIME_INFO=" (00:$(printf "%02d" "${VAL%.*}"))"
	fi
fi
FULL_TEXT="${PERCENTAGE}%"

if [ "$STATUS" = "discharging" ]; then
	FULL_TEXT="${FULL_TEXT} DIS"
elif [ "$STATUS" = "charging" ]; then
	FULL_TEXT="${FULL_TEXT} CHR"
elif [ "$STATUS" = "fully-charged" ]; then
	FULL_TEXT="${FULL_TEXT} FULL"
fi

FULL_TEXT="${FULL_TEXT}${TIME_INFO}"

echo "$FULL_TEXT"
echo "$FULL_TEXT"

# Color logic
if [ "$STATUS" = "discharging" ]; then
	if [ "$PERCENTAGE" -lt 20 ]; then
		echo "#FF0000"
	elif [ "$PERCENTAGE" -lt 40 ]; then
		echo "#FFAE00"
	elif [ "$PERCENTAGE" -lt 60 ]; then
		echo "#FFF600"
	elif [ "$PERCENTAGE" -lt 85 ]; then
		echo "#A8FF00"
	fi

	if [ "$PERCENTAGE" -lt 5 ]; then
		exit 33
	fi
fi

exit 0
