#!/bin/sh
## This is my (demuredemeanor) polybar script for checking Thinkpad Multi Battery (TMB).
## This script handles both one and two batteries, and in the case of the latter provides a weighted percentage.

### Batteries ### {{{
## Prep possible batteries
if [ -e /sys/class/power_supply/BAT0/uevent ]; then
    BAT0="/sys/class/power_supply/BAT0/uevent"
  else
    BAT0=""
fi

## Check for BAT1
if [ -e /sys/class/power_supply/BAT1/uevent ]; then
    BAT1="/sys/class/power_supply/BAT1/uevent"
  else
    BAT1=""
fi
### End Batteries ### }}}

### Data ### {{{
## Aggregate data
if [ "${BAT0}" != "" ] || [ "${BAT1}" != "" ]; then
    ## Originally "/sys/class/power_supply/BAT{0..1}/uevent" but changed into variables make work for non thinkpad cases. paste fails if it can't find a passed file.
    BASE="$(paste -d = ${BAT0} ${BAT1} 2>/dev/null)"

    PERC="$(echo "${BASE}" | awk 'BEGIN {CHARGE="U"} /ENERGY_FULL=/||/ENERGY_NOW=/||/CHARGE_NOW=/||/CHARGE_FULL=/ {split($0,a,"=");  if(a[1]~/FULL/){FULL=a[2]+a[4]}; if(a[1]~/NOW/){NOW=a[2]+a[4]};} END {if(NOW!=""){PERC=int((NOW/FULL)*100)} else {PERC="none"}; print(PERC)}')"

    ## "F" for full, "C" for charging, "D" for discharging, "U" for unknown (Treat is charged")
    STATE="$(echo "${BASE}" | awk 'BEGIN {CHARGE="U"} /STATUS=/ {split($0,a,"="); if(a[2]~/Discharging/||a[4]~/Discharging/){CHARGE="D"} else if(a[2]~/Charging/||a[4]~/Charging/){CHARGE="C"} else if (a[2]~/Full/||a[4]~/Full/){CHARGE="F"};} END {print(CHARGE)}')"

    ## Time till fully charged or discharged, only of currently active battery
    TIME="$(acpi -b | awk '/[0-9]+:[0-9]+:[0-9]+ (until|remaining)/ {if($5!=""){split($5,s,":");if(s[1]!="00"){HOUR=s[1]"h"};if(s[2]!="00"){MIN=s[2]"m"};TIME=HOUR MIN}} END {if(TIME!=""){print TIME} else {print "none"}}')"
fi
### End Data ### }}}

echo $PERC
